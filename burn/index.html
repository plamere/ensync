<!DOCTYPE html>
<html lang="en">
	<head>
		<title>Cannes Burn</title>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
		<script src="js/three.min.js"></script>
		<script src="js/stats.min.js"></script>
		<script src="js/tween.min.js"></script>
		<script src="js/lodash.min.js"></script>
		<script src="js/ensync.js"></script>
		<script src="SceneManager.js?v3"></script>
	</head>
<body>
<script>

var container, stats;
var camera, scene, renderer;
var radius = 100, theta = 0;
var cubeWidth = 20;

var maxSoldiers = 9 * 9 * 9;
var cameraRotateSpeed = 0;
var rows = 27;
var cRows = 9;
var prebeat = .3;
var preseg = .2;
var curScaleAxis = 'y';

var theSong = null;
var sm;     // the scene manager
var ellieG;
var soldierG;
var played = false;
var readyToPlay = false;
var info;

var theScenes = [
    { start:0, duration:300, scene:ElliePulser('simple pulser')},
//    { start:0, duration:300, scene:SimplePulser('simple pulser', 'prebeat', prebeat, 1.5)},
//    { start:0, duration:300, scene:SimplePulser('simple pulser', 'presegment', preseg, 1.5)},

    { start:0, duration:11, scene:introScene()},

    { start:11, duration:22, scene:verse(0)},   // 10 x 10
    { start:33, duration:16, scene:pre(0)},

    { start:49, duration:6, scene:chorus(0)},
    { start:55, duration:11, scene:burn(0)},

    { start:66, duration:22, scene:verse(1)},   // 20 * 20
    { start:88, duration:16, scene:pre(1)},
    { start:104, duration:6, scene:chorus(1)},
    { start:110, duration:10, scene:burn(1)},

    { start:120, duration:12, scene:pre(2)},    // 25 * 25
    { start:132, duration:11, scene:theBreak()},
    { start:143, duration:22, scene:theBuild()},

    { start:165, duration:12, scene:pre(3)},    // 30 * 30
    { start:182, duration:4.7, scene:chorus(2)},
    { start:186.0, duration:2.3, scene:allStop()},
    { start:188.5, duration:11, scene:burn(2)},

    { start:200, duration:16, scene:pre(4)},
    { start:216, duration:6, scene:chorus(3)},
    { start:222, duration:1, scene:finalBurn()},
    //{ start:223, duration:6, scene:fade()},
    { start:226.8, duration:6, scene:fade()},
];


function introScene() {
    return {
        'start': function(start, duration) {
            console.log('introScene', start, duration);
            addSoldiers(100);
            cameraRotateSpeed = .10;
            moveCameraRadius(300, 2,  0);
            makeCircle(ellieG.children, cubeWidth * 0, 6.2, 2, 2);
            waitFor(4,
                function() {
                    var time = 1;
                    makeFlatSquare(soldierG.children, 1.2, time, (duration - 4 - time) / soldierG.children.length);
                    rotateContinuous(ellieG, duration - 4, duration - 4);
                }
            );
        },

        'prebeat' : function(q) {
            if (soldierG.children.length > 0) {
                var idx = q.which % soldierG.children.length;
                var o = soldierG.children[idx];
                fastPulseSingle(o, 4, q.duration / 2);
            }
        }
    }
}

function verse(level) {
    return {
        'start': function(start, duration) {
            cameraRotateSpeed = -.2;
            console.log('verse', level, start, duration);
            waitFor(8, function() {
                makeCylinder(10, 1, 0, 4, 0);
                waitFor(4, function() {
                    makeCylinder(3, 1.4, 0, 4, 0);
                });
            });
        },

        'presegment' : function(q) {
            if (soldierG.children.length > 0) {
                var idx = q.which % soldierG.children.length;
                var o = soldierG.children[idx];
                peakMeter(soldierG.children, q.volume, 8, q.duration);
            }
        }
    }
}

function pre(level) {
    return {
        'start': function(start, duration) {
            cameraRotateSpeed =  cameraRotateSpeed * -1.5;
            console.log('pre', level, start, duration);
            makeSquareOutline(soldierG.children, soldierG.children.length / 4 * 0.8 * cubeWidth, 1, 0);
            waitFor(1, function() {
                if (level == 0) {
                    addSoldiers(15 * 15);   // total 400
                    moveTo(ellieG, 0, cubeWidth * 3 * 3, 0, 3, 0);
                } else if (level == 1) {
                    addSoldiers(25 * 25); // total 625
                } else if (level == 2) {
                    moveTo(ellieG, 0, 0, 0, 3, 0);
                    addSoldiers(30 * 30); // total 900
                }
                var scale = 1.2;
                scaleObject(soldierG, scale, duration, 0);
                moveCameraRadius(radius * scale * 1.1,  duration - 1, 0);

                if (level == 4) {
                    makeHeart(soldierG.children, .5, 4, (duration -1) / soldierG.children.length);
                    rotateContinuous(ellieG, 3, 100);
                } else if (level == 3) {
                    makeSpiral(soldierG.children, 100, 20, 3, (duration - 1) / soldierG.children.length);
                } else {
                    makeFlatSquare(soldierG.children, 1.2, 1, (duration - 1) / soldierG.children.length);
                }
            });
        }
    }
}

function chorus(level) {
    return {
        'start': function(start, duration) {
            if (level != 3) {
                console.log('chorus', level, start, duration);
                //makeHeart(soldierG.children, .5, 1, 0);
                makeVSpiral(soldierG.children, 100, 20, 1, (duration - 3) / soldierG.children.length);
            }
        }
    }
}

function burn(level) {
    return {
        'start': function(start, duration) {
            console.log('burn', level, start, duration);
            makeFlatSquare(soldierG.children, 1.2, .3, 0);
        },

        'presegment' : function(q) {
            if (soldierG.children.length > 0) {
                var idx = q.which % soldierG.children.length;
                var o = soldierG.children[idx];
                peakMeter(soldierG.children, q.volume, 12, q.duration);
                if (q.volume > .90) {
                    slam(5, 2, q.duration);
                }
            }
        }
    }
}

function theBreak(level) {
    return {
        'start': function(start, duration) {
            console.log('theBreak', level, start, duration);
            randomSnow(soldierG.children, 500, duration, 1/soldierG.children.length, 1);
        }
    }
}

function theBuild(level) {
    var pulse = false;
    return {
        'start': function(start, duration) {
            console.log('theBuild', level, start, duration);
            makeCylinderPattern(10, 1, 0, 4, 0);
            randomSnow(soldierG.children, 200, duration - 3.0, 1 /soldierG.children.length, 0);
            waitFor(duration - 9.0, function() {
                pulse = true;
                rotateContinuous(ellieG, 9, 3);
            });
            waitFor(duration - 6.0, function() {
                pulse = true;
                rotateContinuous(ellieG, 6, 3);
            });
            waitFor(duration - 3.0, function() {
                rotateContinuous(ellieG, 3, 3);
                //makeCylinder(60, 1, 2, 2, 0);
                makeHelix(soldierG.children, 80, 1, -200, 3, 0);
            });
        },

        'presegment' : function(q) {
            if (soldierG.children.length > 0 && pulse) {
                var idx = q.which % soldierG.children.length;
                var o = soldierG.children[idx];
                peakMeter(soldierG.children, q.volume, 4, q.duration);
            }
        },

        'end' : function() {
        }
    }
}

function allStop(level) {
    return {
        'start': function(start, duration) {
            console.log('allStop', level, start, duration);
            makeCube(soldierG.children, .3, 0);
        }
    }
}

function finalBurn() {
    return {
        'start': function(start, duration) {
            console.log('finalburn', start, duration);
            moveCameraRadius(900, 2,  0);
        }
    }
}

function fade() {
    return {
        'start': function(start, duration) {
            console.log('fade', start, duration);
            cameraRotateSpeed = .10;
            showFinishedMessage();
            //theta = 0;
        },

        'end' : function() {
            theSong.stop();
        }
    }
}

function SimpleFlatSquare(name, scale, dur, delay) {
    return {
        'start': function(start, duration) {
            curScaleAxis = 'y';
            makeFlatSquare(scale, dur, delay);
        }
    }
}

function SimpleCylinder(name, rows, radius, gap, duration, delay) {
    return {
        'start': function(start, duration) {
            curScaleAxis = 'z';
            makeCylinder(rows, 1, gap, duration, delay);
        }
    }
}

function SimplePulser(name, quanta, time, scale) {
    var pulseFunc = function(q) {
            if (soldierG.children.length > 0) {
                var idx = q.which % soldierG.children.length;
                var o = soldierG.children[idx];
                pulseSingle(o, 4, time);
            }
        };

    var scene = {};
    scene[quanta] = pulseFunc;
    return scene;
}


function peakMeter(objects, value, range, time) {
    _.each(objects, function(o, i) {
        pulseSingle(o, o.meterScale * value * range, time);
    });
}

function EllieRotator(name, rows, radius, gap, duration, delay) {
    return {
        'start': function(start, duration) {
            curScaleAxis = 'z';
            makeCylinder(rows, 1, gap, duration, delay);
        }
    }
}

function ElliePulser() {
    return {
        'prebeat': function(q) {
            var idx = q.which % ellieG.children.length;
            var o = ellieG.children[idx];
            rotateSingle(o, q.duration * 2);
        }
    }
}


function init() {
    container = document.createElement( 'div' );
    document.body.appendChild( container );

    info = document.createElement( 'div' );
    info.style.position = 'absolute';
    info.style.top = '10px';
    info.style.padding = '10px';
    info.style.width = '100%';
    info.style.color = '#cccccc';
    info.style['background-color'] = '#777777';
    info.style.textAlign = 'center';
    info.innerHTML = 'Cannes Burn - Ellie Goulding';
    container.appendChild( info );

    loadSong();
    initKeyInput();

    camera = new THREE.PerspectiveCamera( 70, window.innerWidth / window.innerHeight, 1, 10000 );
    scene = new THREE.Scene();

    addStars();
    addLights();

    initMaterials();

    ellieG = new THREE.Object3D();
    soldierG = new THREE.Object3D();
    scene.add(ellieG);
    scene.add(soldierG);
    addEllies();

    renderer = new THREE.WebGLRenderer();
    renderer.setClearColor( 0x000 );
    renderer.setSize( window.innerWidth, window.innerHeight );
    renderer.sortObjects = false;
    container.appendChild(renderer.domElement);

    /*
    stats = new Stats();
    stats.domElement.style.position = 'absolute';
    stats.domElement.style.top = '0px';
    container.appendChild( stats.domElement );
    */

    window.addEventListener( 'resize', onWindowResize, false );
}

function ready() {
    info.innerHTML = 'Cannes Burn - Ellie Goulding - press space to begin';
    readyToPlay = true;
}

function error(msg) {
    info.innerHTML = msg;
}

function loading(percent) {
    info.innerHTML = 'Cannes Burn - Ellie Goulding - loading ' + percent + "%";
}

function running() {
    info.innerHTML = '';
    info.style.padding = '0px';
}

function showFinishedMessage() {
    info.style.padding = '10px';
    info.innerHTML = 'Cannes Burn - Ellie Goulding - created by <a href="http://twitter.com/plamere">@plamere</a>' +
       ' at Midem Music Hack Day 2014.<br>' +
       ' Powered by <a href="http://the.echonest.com">The Echo Nest</a>' +
       ' and <a href="http://threejs.org"> Three.js</a>.  See ' + 
       '<a href="http://musicmachinery.com/2014/02/03/cannes-burn/" target="_blank">Music Machinery</a> for more info';
}

function queueCmd(o, tween, onComplete) {
    function next() {
        if (o.queue.length > 0) {
            o.queue[0].start();
        }
    }

    tween.onComplete(
        function(obj) {
            if (onComplete) {
                onComplete.call(obj);
            }
            o.queue.shift();
            next();
        }
    );

    if (o.queue === undefined) {
        o.queue = [];
    }

    o.queue.push(tween);
    if (o.queue.length == 1) {
        next();
    }
}


function initKeyInput() {
    window.addEventListener( 'keydown', function ( event ) {
        if (event.which === 39) {   // right arrow
        }
        if (event.which === 37) {  // left arrow
        }

        if (event.which === 38) {  // up arrow
        }
        if (event.which === 40) {  // down arrow
        }

        if (event.which === 80) {  // p
            sm.start();
        }

        if (event.which === 83) {  // s
            sm.stop();
        }

        if (event.which === 32) {  // space
            if (!played && readyToPlay) {
                sm.start();
                played = true;
                running();
            }
        }
    });

}


function moveCameraRadius(newRadius, time, delay) {
    var curPos = { val: radius };
    var newPos = { val: newRadius };

    var tween = new TWEEN.Tween(curPos)
        .to(newPos, time * 1000)
        .onUpdate( function() {
            radius = this.val;
        })
        .easing(TWEEN.Easing.Sinusoidal.InOut)
        .delay(delay * 1000)
        .start();
}

function moveTo(o, x, y, z, time, delay) {
    var curPos = { x: o.position.x, y:o.position.y, z:o.position.z };
    var newPos = { x: x + dither(), y:y + dither(), z:z + dither() };

    var tween = new TWEEN.Tween(curPos)
        .to(newPos, time * 1000)
        .onUpdate( function() {
            o.position.x = this.x;
            o.position.y = this.y;
            o.position.z = this.z;
        })
        .easing(TWEEN.Easing.Sinusoidal.InOut)
        .delay(delay * 1000)
        .start();
}

function dither() {
    return Math.random() / 3;
}

function oMoveTo(o, x, y, z, time, delay) {
    var curPos = { x: o.position.x, y:o.position.y, z:o.position.z };
    var newPos = { x: x + dither(), y:y + dither(), z:z + dither() };

    var tween = new TWEEN.Tween(curPos)
        .to(newPos, time * 1000)
        .onUpdate( function() {
            o.position.x = this.x;
            o.position.y = this.y;
            o.position.z = this.z;
        })
        .easing(TWEEN.Easing.Sinusoidal.InOut)
        .delay(delay * 1000)
        .start();

    if (o.rotation.x != 0 || o.rotation.y != 0 || o.rotation.z != 0) {
        rotateTo(o, 0,0,0, time, delay);
    }
}

function rotateTo(o, x, y, z, time, delay) {
    var curPos = { x: o.rotation.x, y:o.rotation.y, z:o.rotation.z };
    var newPos = { x: x, y:y, z:z };

    var tween = new TWEEN.Tween(curPos)
        .to(newPos, time * 1000)
        .onUpdate( function() {
            o.rotation.x = this.x;
            o.rotation.y = this.y;
            o.rotation.z = this.z;
        })
        .easing(TWEEN.Easing.Sinusoidal.InOut)
        .delay(delay * 1000)
        .start();
}

function makeSquare() {
    function getRow(i) {
        return Math.floor(i / rows) * 20 - rows / 2 * 20;
    }

    function getCol(i) {
        return i % rows * 20 - rows / 2 * 20;
    }

    soldierG.children.forEach(function(o, i) {
        oMoveTo(o, getRow(i), getCol(i), 0, 1, i);
    });
}

function makeFlatSquare(objects, scale, duration, delay) {
    var cubeScale = cubeWidth * scale;
    var rows = Math.floor(Math.sqrt(objects.length));
    function getRow(i) {
        return Math.floor(i / rows) * cubeScale - rows / 2 * cubeScale;
    }

    function getCol(i) {
        return i % rows * cubeScale - rows / 2 * cubeScale;
    }

    objects.forEach(function(o, i) {
        oMoveTo(o, getRow(o.which), 0, getCol(o.which), duration, o.which * delay);
    });
}


function scaleObject(object, scale, duration, delay) {
    var curState = {x:object.scale.x, y:object.scale.y, z:object.scale.z };
    var newState = {x:object.scale.x * scale, y:object.scale.y * scale, z:object.scale.z * scale };
    var tween = new TWEEN.Tween(curState)
        .to(newState, duration * 1000)
        .onUpdate( function() {
            object.scale = this;
        })
        .delay(delay * 1000)
        .easing(TWEEN.Easing.Linear.None)
        .start();
}

function makeSquareOutline(objects, width, duration, delay) {
    var sideLength = Math.floor(objects.length / 4);

    function getRow(i) {
        var side = Math.floor(i % 4);
        var row = 0;
        if (side == 1) {
            row = width;
        } else if (side == 3) {
            row = -width;
        } else {
            var which = i % sideLength;
            row = -width + which/sideLength * width * 2;
        }
        return row;
    }

    function getCol(i) {
        var side = Math.floor(i % 4);
        var col = 0;
        if (side == 0) {
            col = width;
        } else if (side == 2) {
            col = -width;
        } else {
            var which = i % sideLength;
            col = -width + which/sideLength * width * 2;
        }
        return col;
    }

    objects.forEach(function(o, i) {
        var row = getRow(o.which);
        var col = getCol(o.which);
        oMoveTo(o, row, 0, col, duration, o.which * delay);
    });
}

function waitFor(delay, func) {
    var curState = {x:0 };
    var finalState = {x:1};
    var tween = new TWEEN.Tween(curState)
        .to(finalState, delay * 1000).onComplete(func).start();
}

function makeCircle(objects, height, radiusFactor, time, delay) {
    var numObjects = objects.length;
    var radius = cubeWidth * numObjects / (2 * Math.PI);
    radius *= radiusFactor;

    objects.forEach(function(o, i) {
        var angle = 2 * Math.PI * i / numObjects;
        var x = radius * Math.sin(angle);
        var y = radius * Math.cos(angle);
        moveTo(o, x, height, y, time, delay);
        rotateTo(o, 0, angle, 0, time, delay);
    });
}

function makeSpiral(objects, initialRadius, padding, time, delay) {
    var radius = initialRadius;
    var cw = cubeWidth + padding;
    var angle = 0;
    objects.forEach(function(o, i) {
        var circumference = 2 * Math.PI * 2 * (radius - cw);
        var numBlocks = circumference / cw;
        var angleDelta = 2 * Math.PI / numBlocks;
        var x = radius * Math.sin(angle);
        var y = radius * Math.cos(angle);
        angle += angleDelta;
        radius += cubeWidth / numBlocks;
        moveTo(o, x, -40, y, time, i * delay);
        rotateTo(o, 0, angle, 0, time, i* delay);
    });
}

function makeHelix(objects, radius, padding, initialHeight, time, delay) {
    var cw = cubeWidth + padding;
    var angle = 0;
    var circumference = 2 * Math.PI * 2 * (radius - cw);
    var z = initialHeight;
    var numBlocks = circumference / cw;
    var heightDelta = cw/numBlocks;
    var angleDelta = Math.PI * 2 / numBlocks;

    objects.forEach(function(o, i) {
        var x = radius * Math.sin(angle);
        var y = radius * Math.cos(angle);
        angle += angleDelta;
        z += heightDelta;
        moveTo(o, x, z, y, time, i * delay);
        rotateTo(o, 0, angle, 0, time, i* delay);
    });
}

function randomSnow(objects, height, time, delay, fwd) {
    var list = _.clone(objects);
    list = _.shuffle(list);
    _.each(list, function(o, i) {
        //var time = Math.random() * 2 + 2;
        var x = Math.random() * 200 - 100;
        var z = Math.random() * 200 - 100;
        var y = Math.random() * 600 - 300;
        if (i % 2 == fwd) {
            y += height
        } else {
            y -= height
        }
        moveTo(o, x, y, z, time, i * delay);
    });
}

function makeVSpiral(objects, initialRadius, padding, time, delay) {
    var radius = initialRadius;
    var cw = cubeWidth + padding;
    var angle = 0;
    objects.forEach(function(o, i) {
        var circumference = 2 * Math.PI * 2 * (radius - cw);
        var numBlocks = circumference / cw;
        var angleDelta = 2 * Math.PI / numBlocks;
        var x = radius * Math.sin(angle);
        var y = radius * Math.cos(angle);
        angle += angleDelta;
        radius += cubeWidth / numBlocks;
        moveTo(o, x, y, 0, time, i * delay);
        rotateTo(o, 0, angle, 0, time, i* delay);
    });
}

function makeSphere(objects, radiusFactor, time, delay) {
    var numObjects = objects.length;
    var radius = Math.pow(numObjects / Math.PI, 1/3);
    radius *= radiusFactor;

    objects.forEach(function(o, i) {
        var angle = 2 * Math.PI * i / numObjects;
        var x = radius * Math.sin(angle);
        var y = radius * Math.cos(angle);
        moveTo(o, x, height, y, time, delay);
        rotateTo(o, 0, angle, 0, time, delay);
    });
}

function makeCylinder(rows, scale, gap, duration, delay) {
    var numObjects = soldierG.children.length;
    var objectsPerRow = Math.floor(numObjects/rows);
    var radius = cubeWidth * objectsPerRow / (2 * Math.PI) * scale;
    var height = rows * (cubeWidth + gap);
    soldierG.children.forEach(function(o, i) {
        var row = Math.floor(i / objectsPerRow);
        var angle = ((i % objectsPerRow) /objectsPerRow) * 2 * Math.PI;
        var x = radius * Math.sin(angle);
        var z = radius * Math.cos(angle);
        var y = row * (cubeWidth + gap) - height / 2;
        moveTo(o, x, y, z, duration, i * delay);
        rotateTo(o, 0, angle, 0, duration, i * delay);
    });
}

function makeCylinderPattern(rows, radius, gap, duration, delay) {
    var numObjects = soldierG.children.length;
    var objectsPerRow = Math.floor(numObjects/rows);
    if (radius <= 0) {
        radius = cubeWidth * objectsPerRow / (2 * Math.PI);
    }

    var height = rows * (cubeWidth + gap);
    soldierG.children.forEach(function(o, i) {
        var row = Math.floor(i / objectsPerRow);
        var angle = ((i % objectsPerRow) /objectsPerRow) * 2 * Math.PI;
        var x = radius * Math.sin(angle);
        var z = radius * Math.cos(angle);
        var y = row * (cubeWidth + gap) - height / 2;
        // moveTo(o, x, y, z, duration, i * delay);
        rotateTo(o, 0, angle, 0, duration, i * delay);
    });
}

function slam(wideScale, narrowScale, time) {
    var rows = Math.sqrt(soldierG.children.length);

    function getRow(i, scale) {
        var cubeScale = cubeWidth * scale;
        return Math.floor(i / rows) * cubeScale - rows / 2 * cubeScale;
    }

    function getCol(i, scale) {
        var cubeScale = cubeWidth * scale;
        return i % rows * cubeScale - rows / 2 * cubeScale;
    }

    function slamOne(o, wide, narrow) {
        var curState = {x:o.position.x, y:o.position.y, z:o.position.z };
        var finalState = {x:o.position.x, y:o.position.y, z:o.position.z };

        var tweenThere = new TWEEN.Tween(curState)
            .to(wide, time / 4 * 1000)
            .onUpdate( function() {
                o.position = this;
            })
            .easing(TWEEN.Easing.Elastic.Out)

        var tweenBack = new TWEEN.Tween(curState)
            .to(narrow, time * 3 / 4 * 1000)
            .onUpdate( function() {
                o.position = this;
            })
            .easing(TWEEN.Easing.Quartic.Out)
        tweenThere.chain(tweenBack);
        tweenThere.start();
    }

    soldierG.children.forEach(function(o, i) {
        var high = cubeWidth * 2;
        var low = cubeWidth * 2;
        var wide = {x:getRow(o.which, wideScale), y: o.which % 2 === 1 ? high : low, z:getCol(o.which, wideScale) };
        var narrow = {x:getRow(o.which, narrowScale), y:0, z:getCol(o.which, narrowScale) };
        slamOne(o, wide, narrow);
    });
}

function makeCube(objs, duration, delay) {
    var x = 0, y= 0, z = 0;
    var cRows = Math.round(Math.pow(objs.length, 1/3));

    function c2s(i) {
        return i * cubeWidth - cRows / 2 * cubeWidth;
    }

    objs.forEach(function(o, i) {
        oMoveTo(o, c2s(x), c2s(y), c2s(z), duration, delay);
        if (++x >= cRows) {
            x = 0;
            if (++y >= cRows) {
                y = 0;
                z++;
            }
        }
    });
}

function makeHeart(objs, scale, duration, delay) {
    var x = 0, y= 0, z = 0;
    var hearts = 100;
    var cRows = Math.round(objs.length / hearts);

    function c2s(i) {
        return i * cubeWidth * scale + Math.random();
    }

    var sobjs = _.clone(objs);
    sobjs = _.shuffle(sobjs);
    sobjs.forEach(function(o, i) {
        var angle = (o.which % hearts) / hearts * Math.PI * 2;
        var sinx = Math.sin(angle);
        var cosx = Math.cos(angle);
        var x = 16 * sinx * sinx * sinx;
        var y = 13 * Math.cos(angle) - 5 * Math.cos(2 * angle) - 2 * Math.cos(3*angle) - Math.cos(4 * angle);
        var z = Math.floor(o.which / hearts) - cRows / 2;
        oMoveTo(o, c2s(x), c2s(y), c2s(z), duration, o.which * delay);
        rotateTo(o, 0, 0, angle, duration, o.which * delay);
    });
}

/*
function makeSpiral(objs, scale, duration, delay) {
    var x = 0, y= 0, z = 0;
    var cRows = Math.round(objs.length / hearts);
    var objectsPerRow = obs.length;
    var radius = cubeWidth;

    function c2s(i) {
        return i * cubeWidth * scale + Math.random();
    }

    soldierG.children.forEach(function(o, i) {
        var angle = ((o.which % objectsPerRow) /objectsPerRow) * 2 * Math.PI;
        var x = radius * Math.sin(angle);
        var z = radius * Math.cos(angle);
        var y = row * (cubeWidth + gap) - height / 2;
        moveTo(o, x, y, z, duration, i * delay);
        rotateTo(o, 0, angle, 0, duration, i * delay);
    });
}
*/



function wave(height) {
    soldierG.children.forEach(function(o, i) {
        pulseSingle(o, .08, i * .04);
    });
}


function pulseSingle(o, scale, period) {
    var curState = { val:1 };
    var newState = { val: 1 + scale };
    var doneState = { val:1};

    var tweenThere = new TWEEN.Tween(curState)
        .to(newState, 1000 * period / 2)
        .onUpdate( function() {
            o.scale[curScaleAxis] = this.val;
        //}).easing(TWEEN.Easing.Elastic.Out);
        }).easing(TWEEN.Easing.Exponential.Out);

    var tweenBack = new TWEEN.Tween(newState)
        .to(doneState, 1000 * period / 2)
        .onUpdate( function() {
            o.scale[curScaleAxis] = this.val;
        })
        //.easing(TWEEN.Easing.Quartic.Out)
        .easing(TWEEN.Easing.Linear.None)
        .onComplete(function() {
            o.scale = {x:1, y:1, z:1 };
        });
    tweenThere.chain(tweenBack);
    tweenThere.start();
}

function fastPulseSingle(o, scale, period) {
    var curState = { val:1 };
    var newState = { val: 1 + scale };
    var doneState = { val:1};

    var tweenThere = new TWEEN.Tween(curState)
        .to(newState, 1000 * period / 2)
        .onUpdate( function() {
            o.scale[curScaleAxis] = this.val;
        }).easing(TWEEN.Easing.Elastic.Out);

    var tweenBack = new TWEEN.Tween(newState)
        .to(doneState, 1000 * period / 2)
        .onUpdate( function() {
            o.scale[curScaleAxis] = this.val;
        })
        .easing(TWEEN.Easing.Quartic.Out)
        .onComplete(function() {
            o.scale = {x:1, y:1, z:1 };
        });
    tweenThere.chain(tweenBack);
    tweenThere.start();
}

function rotateSingle(o, period) {
    var curState = { val:0 };
    var newState = { val: Math.PI / 2 };

    var tweenThere = new TWEEN.Tween(curState)
        .to(newState, 1000 * period)
        .onUpdate( function() {
            o.rotation.y = this.val;
        })
        .easing(TWEEN.Easing.Elastic.Out);
    tweenThere.start();
}

function rotateContinuous(o, period, time) {
    var curState = { val:0 };
    var newState = { val: Math.PI * 2 };
    var startTime = theSong.now();

    var tweenThere = new TWEEN.Tween(curState)
        .to(newState, 1000 * period)
        .onUpdate( function() {
            o.rotation.y = this.val;
        })
        .easing(TWEEN.Easing.Linear.None)
        .onComplete(function() {
            if (theSong.now() - startTime < time) {
                o.rotation.y = 0;
                curState.val = 0;
                tweenThere.start();
            }
        });
    tweenThere.start();
}

function randomSlew() {
    soldierG.children.forEach(function(o, i) {
        var curPos = { x: o.position.x, y:o.position.y, z:o.position.z };

        var newPos = {}
        newPos.x = Math.random() * 800 - 400;
        newPos.y = Math.random() * 800 - 400;
        newPos.z = Math.random() * 800 - 400;

        var tween = new TWEEN.Tween(curPos)
            .to(newPos, 2000)
            .onUpdate( function() {
                o.position.x = this.x;
                o.position.y = this.y;
                o.position.z = this.z;
            })
            .easing(TWEEN.Easing.Sinusoidal.In)
            .repeat(1)
            .yoyo(true)
            .delay(0 + i * 2)
            .start();
    });
}


function loadSong() {
    ENSync.loadSongFromJSON("burn.js", "burn.mp3",
        function(song) {
            theSong = song;
            var events = {
                'prebeats':prebeat,
                'presegments':preseg
            }
            sm = SceneManager(theSong, events);
            sm.addScenes(theScenes);
            if (renderer) {
                ready();
                animate();
            } else {
                error("Sorry - your browser doesn't seem to support webgl");
            }
        },

        function(err) {
            console.log('ERROR ' + err);
            error('Sorry, had trouble loading up the song');
        },

        function(progress) {
            console.log('loading progress', progress);
            loading(progress);
        }
    );
}

function addEllies() {
    var cw = cubeWidth * 3; 
    var cwp = cubeWidth * 3 + 10; 
    var geometry = new THREE.CubeGeometry( cw, cw, cw);
    var imageCount = 11;

    for (var i = 0; i < imageCount; i++) {
       var texture =  THREE.ImageUtils.loadTexture('images/image' + i + '.jpg');
       texture.flipY = true;
       var material = new THREE.MeshLambertMaterial({
           map: texture
       });
       var object = new THREE.Mesh( geometry, material);
       object.position.x = cwp * i - cwp * imageCount / 2 ;
       object.position.y = 0
       object.position.z = 0;
       object.which = i;
       ellieG.add(object);
    }
    // makeCircle(ellieG.children, cubeWidth * 6, 6.2);
}


var maxMaterials = 32;
var materials = [];

function initMaterials() {
    for ( var i = 0; i < maxMaterials; i ++ ) {
        var color = Math.random() * 0xffffff;
        var color2 = Math.random() * 0xffffff;
        var material = new THREE.MeshPhongMaterial( 
            { color: color, ambient:color2, specular:0x050505, shininess:100 } );
        materials.push(material);
    }
}

function addSoldiers(total) {
   var count = total - soldierG.children.length;
   var geometry = new THREE.CubeGeometry( cubeWidth, cubeWidth, cubeWidth );
    for ( var i = 0; i < count; i ++ ) {
        var soldier = new THREE.Mesh( geometry, materials[i % maxMaterials]);
        soldier.position.x = Math.random() * 1200 - 600;
        soldier.position.y = 1200 + Math.random() * 100;
        soldier.position.z = Math.random() * 1200 - 600;
        soldierG.add(soldier);
    }

    var shuffled = _.shuffle(soldierG.children);
    // var shuffled = soldierG.children;
    _.each(shuffled, function(o, i) {
        o.which = i;
    });
    calcMeterScale();
}


function calcMeterScale() {
    // calculate meter scale
    var rows = Math.floor(Math.sqrt(soldierG.children.length));
    var center = rows / 2;
    var maxDistance = Math.sqrt(center * center + center * center);
    _.each(soldierG.children, function(o, i) {
        var r = o.which % rows;
        var c = Math.floor(o.which / rows);
        var dx = center - r;
        var dy = center - c;
        var distance = Math.sqrt(dx * dx + dy * dy);
        o.meterScale = 1 - distance / maxDistance;
        o.meterScale = o.meterScale * o.meterScale;
    });
}


function addLights() {
    var light = new THREE.PointLight( 0xff00ff, .5, 0 );
    light.position.set( 200, 200, 200 ).normalize();
    scene.add( light );

    var light2 = new THREE.PointLight( 0xffffff, 1, 0 );
    light2.position.set( -200, -200, -200 ).normalize();
    scene.add( light2 );

    var light3 = new THREE.DirectionalLight( 0xffffff );
    light3.position.set( -1, -1, -1 ).normalize();
    scene.add( light3 );

    var light4 = new THREE.DirectionalLight( 0xffffff, 2 );
    light4.position.set( 1, 1, 1 ).normalize();
    scene.add( light4 );
}

function addStars() {
    var i, r = 200, starsGeometry = [ new THREE.Geometry(), new THREE.Geometry() ];

    for ( i = 0; i < 250; i ++ ) {

        var vertex = new THREE.Vector3();
        vertex.x = Math.random() * 2 - 1;
        vertex.y = Math.random() * 2 - 1;
        vertex.z = Math.random() * 2 - 1;
        vertex.multiplyScalar( r );

        starsGeometry[ 0 ].vertices.push( vertex );

    }

    for ( i = 0; i < 1500; i ++ ) {

        var vertex = new THREE.Vector3();
        vertex.x = Math.random() * 2 - 1;
        vertex.y = Math.random() * 2 - 1;
        vertex.z = Math.random() * 2 - 1;
        vertex.multiplyScalar( r );

        starsGeometry[ 1 ].vertices.push( vertex );

    }

    var stars;
    var starsMaterials = [
        new THREE.ParticleSystemMaterial( { color: 0xffffff, size: 2, sizeAttenuation: false } ),
        new THREE.ParticleSystemMaterial( { color: 0xeeeeee, size: 1, sizeAttenuation: false } ),
        new THREE.ParticleSystemMaterial( { color: 0xcccccc, size: 2, sizeAttenuation: false } ),
        new THREE.ParticleSystemMaterial( { color: 0xdddddd, size: 1, sizeAttenuation: false } ),
        new THREE.ParticleSystemMaterial( { color: 0xbbbbbb, size: 2, sizeAttenuation: false } ),
        new THREE.ParticleSystemMaterial( { color: 0x1a1a1a, size: 1, sizeAttenuation: false } )
    ];

    for ( i = 10; i < 30; i ++ ) {

        stars = new THREE.ParticleSystem( starsGeometry[ i % 2 ], starsMaterials[ i % 6 ] );

        stars.rotation.x = Math.random() * 6;
        stars.rotation.y = Math.random() * 6;
        stars.rotation.z = Math.random() * 6;

        s = i * 10;
        stars.scale.set( s, s, s );

        stars.matrixAutoUpdate = false;
        stars.updateMatrix();

        scene.add( stars );

    }
}

function onWindowResize() {
    camera.aspect = window.innerWidth / window.innerHeight;
    camera.updateProjectionMatrix();
    renderer.setSize( window.innerWidth, window.innerHeight );
}

//

function animate() {
    requestAnimationFrame( animate );
    TWEEN.update();
    sm.update();
    render();
    // stats.update();
}

function render() {
    theta += cameraRotateSpeed;
    camera.position.x = radius * Math.sin( THREE.Math.degToRad( theta ) );
    camera.position.y = radius * Math.sin( THREE.Math.degToRad( theta ) );
    camera.position.z = radius * Math.cos( THREE.Math.degToRad( theta ) );

    camera.lookAt( scene.position );
    renderer.render( scene, camera );
}

init();


</script>
</body>
<script type="text/javascript">

  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-3675615-27']);
  _gaq.push(['_trackPageview']);

  (function() {
    var ga = document.createElement('script'); ga.type =
'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' :
'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0];
s.parentNode.insertBefore(ga, s);
  })();

</script>
</html>
